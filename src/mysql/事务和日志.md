# 事务
假如我们有一段这样的业务需求：A发起转账10000给B -> A银行卡减10000元 -> B银行卡增加10000元
```
update account set balance=balance-10000 where name="A";
update account set balance=balance+10000 where name="B";
```
如果在执行第二条SQL的时候，MySQL或者Web服务崩溃了，那么就会造成B没有收到转账的钱，而A却扣掉了。因此数据库引入事务概念，数据库事务指的是一组数据操作，事务内的操作要么就是全部成功，要么就是全部失败，什么都不做，其实不是没做，是可能做了一部分但是只要有一步失败，就要回滚所有操作。因此上述事务操作为
```
start transaction
update account set balance=balance-10000 where name="A";
update account set balance=balance+10000 where name="B";
commit
```
如何来实现上面的过程呢？首先就要考虑两个问题，第一，如何来保证原子性；第二，commit之后保证数据落库

## 事务的四大特性：ACID
* 原子性(A)：事务是最小单位，不可再分
* 一致性(C)：事务要求所有的DML语句操作的时候，必须保证同时成功或者同时失败
* 隔离性(I)：事务A和事务B之间具有隔离性
* 持久性(D)：是事务的保证，事务终结的标志(内存的数据持久到硬盘文件中)

## 事务如何保证原子性
OK，是利用Innodb的undo log。
undo log名为回滚日志，是实现原子性的关键，当事务回滚时能够撤销所有已经成功执行的sql语句，他需要记录你要回滚的相应日志信息。
例如

1、当你delete一条数据的时候，就需要记录这条数据的信息，回滚的时候，insert这条旧数据

2、当你update一条数据的时候，就需要记录之前的旧值，回滚的时候，根据旧值执行update操作

3、当年insert一条数据的时候，就需要这条记录的主键，回滚的时候，根据主键执行delete操作

undo log记录了这些回滚需要的信息，当事务执行失败或调用了rollback，导致事务需要回滚，便可以利用undo log中的信息将数据回滚到修改之前的样子。

ps:具体的undo log日志长啥样，这个可以写一篇文章了。而且写出来，看的人也不多，姑且先这么简单的理解吧。

## 事务如何实现持久性
OK，是利用Innodb的redo log。
正如之前说的，Mysql是先把磁盘上的数据加载到内存中，在内存中对数据进行修改，再刷回磁盘上。如果此时突然宕机，内存中的数据就会丢失。 怎么解决这个问题？ 简单啊，事务提交前直接把数据写入磁盘就行啊。 这么做有什么问题？

只修改一个页面里的一个字节，就要将整个页面刷入磁盘，太浪费资源了。毕竟一个页面16kb大小，你只改其中一点点东西，就要将16kb的内容刷入磁盘，听着也不合理。
毕竟一个事务里的SQL可能牵涉到多个数据页的修改，而这些数据页可能不是相邻的，也就是属于随机IO。显然操作随机IO，速度会比较慢。
于是，决定采用redo log解决上面的问题。当做数据修改的时候，不仅在内存中操作，还会在redo log中记录这次操作。当事务提交的时候，会将redo log日志进行刷盘(redo log一部分在内存中，一部分在磁盘上)。当数据库宕机重启的时候，会将redo log中的内容恢复到数据库中，再根据undo log和binlog内容决定回滚数据还是提交数据。

采用redo log的好处？ 其实好处就是将redo log进行刷盘比对数据页刷盘效率高，具体表现如下

redo log体积小，毕竟只记录了哪一页修改了啥，因此体积小，刷盘快。
redo log是一直往末尾进行追加，属于顺序IO。效率显然比随机IO来的快。
ps:不想具体去谈redo log具体长什么样，因为内容太多了。

## 事务如何实现隔离性
OK,利用的是锁和MVCC机制。

## 事务如何实现一致性
OK，这个问题分为两个层面来说。
从数据库层面，数据库通过原子性、隔离性、持久性来保证一致性。也就是说ACID四大特性之中，C(一致性)是目的，A(原子性)、I(隔离性)、D(持久性)是手段，是为了保证一致性，数据库提供的手段。数据库必须要实现AID三大特性，才有可能实现一致性。例如，原子性无法保证，显然一致性也无法保证。

但是，如果你在事务里故意写出违反约束的代码，一致性还是无法保证的。例如，你在转账的例子中，你的代码里故意不给B账户加钱，那一致性还是无法保证。因此，还必须从应用层角度考虑。

从应用层面，通过代码判断数据库数据是否有效，然后决定回滚还是提交数据！

## binlog
binlog是MySQL server层提供的日志服务，不管什么存储引擎都有。redo log和undo log是innodb存储引擎所特有，因此innodb支持事务，而myisam不支持。

## 参考
* [MySQL深入理解事务的来龙去脉](https://juejin.im/post/5cbc049de51d456e7b372089)
* [详细分析MySQL事务日志(redo log和undo log)](https://juejin.im/entry/5ba0a254e51d450e735e4a1f)
* [『浅入深出』MySQL 中事务的实现](https://draveness.me/mysql-transaction/)
* [深入学习MySQL事务：ACID特性的实现原理](https://www.cnblogs.com/kismetv/p/10331633.html)
